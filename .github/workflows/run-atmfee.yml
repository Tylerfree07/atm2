name: ATM Application CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'

    - name: Create Maven structure
      run: |
        mkdir -p src/main/java/atmfree
        mkdir -p src/main/resources
        mv AtmFee.java src/main/java/atmfree/
        
    - name: Setup Maven project
      run: |
        cat > pom.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <project xmlns="http://maven.apache.org/POM/4.0.0"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            
            <groupId>com.atmfree</groupId>
            <artifactId>atm-application</artifactId>
            <version>1.0-SNAPSHOT</version>
            
            <properties>
                <maven.compiler.source>17</maven.compiler.source>
                <maven.compiler.target>17</maven.compiler.target>
                <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
            
            <dependencies>
                <!-- SQLite JDBC -->
                <dependency>
                    <groupId>org.xerial</groupId>
                    <artifactId>sqlite-jdbc</artifactId>
                    <version>3.44.1.0</version>
                </dependency>
                
                <!-- iText PDF -->
                <dependency>
                    <groupId>com.itextpdf</groupId>
                    <artifactId>itextpdf</artifactId>
                    <version>5.5.13.3</version>
                </dependency>
                
                <!-- JSON -->
                <dependency>
                    <groupId>org.json</groupId>
                    <artifactId>json</artifactId>
                    <version>20231013</version>
                </dependency>
                
                <!-- JavaMail API -->
                <dependency>
                    <groupId>com.sun.mail</groupId>
                    <artifactId>javax.mail</artifactId>
                    <version>1.6.2</version>
                </dependency>
            </dependencies>
            
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-assembly-plugin</artifactId>
                        <version>3.6.0</version>
                        <configuration>
                            <archive>
                                <manifest>
                                    <mainClass>atmfree.AtmFee</mainClass>
                                </manifest>
                            </archive>
                            <descriptorRefs>
                                <descriptorRef>jar-with-dependencies</descriptorRef>
                            </descriptorRefs>
                        </configuration>
                        <executions>
                            <execution>
                                <phase>package</phase>
                                <goals>
                                    <goal>single</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </project>
        EOF

    - name: Initialize resources
      run: |
        echo "LAST_UPDATE:2024-01-01" > src/main/resources/rates.txt
        echo "USD:1.0" >> src/main/resources/rates.txt
        echo "EUR:0.92" >> src/main/resources/rates.txt
        echo "GBP:0.79" >> src/main/resources/rates.txt

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Run tests
      env:
        ATM_API_KEY: ${{ secrets.ATM_API_KEY }}
        ATM_FROM_EMAIL: ${{ secrets.ATM_FROM_EMAIL }}
        ATM_EMAIL_PASSWORD: ${{ secrets.ATM_EMAIL_PASSWORD }}
      run: |
        java -jar target/atm-application-1.0-SNAPSHOT-jar-with-dependencies.jar

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: atm-application
        path: target/atm-application-1.0-SNAPSHOT-jar-with-dependencies.jar